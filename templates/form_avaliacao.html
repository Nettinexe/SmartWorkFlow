{% extends 'base.html' %}
{% load static %}

{% block title %}Avaliando {{ materia_codigo }} - {{ relatorio.aluno.nome_completo }}{% endblock %}

{% block content %}
<div class="container pb-5">
    
    <div class="mb-4">
        <a href="{% url 'avaliar_aluno' relatorio.aluno.id %}?tri={{ relatorio.trimestre }}" class="text-decoration-none text-muted small">
            <i class="bi bi-arrow-left"></i> Voltar para seleção de matérias
        </a>
        <div class="d-flex align-items-center mt-2">
            <div class="bg-primary text-white rounded p-2 me-3">
                <i class="bi bi-journal-check fs-3"></i>
            </div>
            <div>
                <h2 class="text-primary fw-bold mb-0">{{ materia_codigo }}</h2>
                <p class="text-muted mb-0">Avaliação: <strong>{{ relatorio.aluno.nome_completo }}</strong></p>
            </div>
        </div>
    </div>

    {% if pode_editar %}
    <div class="card border-primary border-opacity-25 mb-5 shadow-sm bg-white">
        <div class="card-body p-4">
            <label for="termo_busca" class="fw-bold text-primary mb-2">
                <i class="bi bi-search me-1"></i> Adicionar Habilidade BNCC
            </label>
            <form method="post" class="d-flex gap-2">
                {% csrf_token %}
                <div class="flex-grow-1">
                    <input type="text" id="termo_busca" name="termo_busca" class="form-control form-control-lg" 
                           placeholder="Digite o código (ex: EF06LP01)" required>
                </div>
                <button type="submit" name="btn_adicionar" class="btn btn-primary px-4 fw-bold shadow-sm">
                    <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Adicionar</span>
                </button>
            </form>
            <div class="form-text small mt-2">
                <i class="bi bi-info-circle"></i> O sistema buscará automaticamente a descrição da habilidade para o <strong>{{ relatorio.aluno.turma.serie_curricular }}º ano</strong>.
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mb-5 shadow-sm d-flex align-items-center">
        <i class="bi bi-lock-fill fs-3 me-3"></i>
        <div>
            <strong>Modo Somente Leitura:</strong> 
            Este relatório está com status <span class="badge bg-warning text-dark">{{ relatorio.get_status_display }}</span>. Edições estão desabilitadas.
        </div>
    </div>
    {% endif %}

    <form method="post" id="mainForm">
        {% csrf_token %}
        
        {% if avaliacoes %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-secondary mb-0">Habilidades em Avaliação ({{ avaliacoes.count }})</h5>
                {% if pode_editar %}
                <span class="badge bg-light text-muted border">Lembre-se de salvar antes de sair</span>
                {% endif %}
            </div>
            
            {% for av in avaliacoes %}
            <div class="card mb-4 shadow-sm border-0 border-start border-4 {% if av.nivel %}border-success{% else %}border-secondary opacity-75{% endif %}">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-md-7 border-end-md">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge bg-dark text-white px-3 py-2">{{ av.competencia.codigo }}</span>
                                
                                {% if pode_editar and not av.nivel %}
                                    <button type="submit" name="btn_excluir" value="{{ av.id }}" 
                                            class="btn btn-outline-danger btn-sm border-0" 
                                            onclick="return confirm('Remover esta competência da avaliação atual?');">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                {% elif av.nivel %}
                                    <span class="badge bg-success-subtle text-success border border-success-subtle px-2">Avaliado</span>
                                {% endif %}
                            </div>

                            <p class="text-dark fw-medium mb-3" style="line-height: 1.6;">{{ av.competencia.habilidade }}</p>
                            
                            <button type="button" class="btn btn-outline-warning btn-sm fw-bold" 
                                    data-bs-toggle="modal" data-bs-target="#modalSugestao{{ av.competencia.id }}">
                                <i class="bi bi-lightbulb-fill me-1"></i> Sugerir nova Atividade
                            </button>
                        </div>

                        <div class="col-md-5">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-primary small">Nível de Desenvolvimento:</label>
                                <select name="nivel_{{ av.competencia.id }}" class="form-select form-select-lg border-2" 
                                        {% if not pode_editar %}disabled{% endif %} required>
                                    <option value="">Selecione o nível...</option>
                                    <option value="1" {% if av.nivel == '1' %}selected{% endif %}>1 - Não desenvolvido</option>
                                    <option value="2" {% if av.nivel == '2' %}selected{% endif %}>2 - Em desenvolvimento (início)</option>
                                    <option value="3" {% if av.nivel == '3' %}selected{% endif %}>3 - Em desenvolvimento (parcial)</option>
                                    <option value="4" {% if av.nivel == '4' %}selected{% endif %}>4 - Desenvolvido</option>
                                    <option value="5" {% if av.nivel == '5' %}selected{% endif %}>5 - Plenamente desenvolvido</option>
                                </select>
                            </div>

                            <div>
                                <label class="form-label fw-bold text-primary small">Observação Pedagógica (Opcional):</label>
                                <textarea name="obs_{{ av.competencia.id }}" class="form-control" rows="3" 
                                          placeholder="Ex: Demonstra interesse, mas necessita de apoio visual..."
                                          {% if not pode_editar %}disabled{% endif %}>{{ av.observacao_especifica|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            {% if pode_editar %}
            <div class="sticky-bottom bg-white p-3 border-top shadow-lg d-md-none">
                 <button type="submit" name="btn_salvar" class="btn btn-success w-100 fw-bold py-3">SALVAR TUDO</button>
            </div>
            
            <div class="d-grid gap-2 mt-5 mb-5 d-none d-md-block">
                <button type="submit" name="btn_salvar" class="btn btn-success btn-lg shadow-lg fw-bold py-3 w-100">
                    <i class="bi bi-device-hdd-fill me-2"></i> SALVAR TODAS AS ALTERAÇÕES
                </button>
            </div>
            {% endif %}

        {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="bi bi-file-earmark-plus display-1 text-muted opacity-25"></i>
                </div>
                <h4 class="text-muted">Nenhum objetivo adicionado ainda.</h4>
                <p class="text-muted">Trabalhou algo específico em <strong>{{ materia_codigo }}</strong>? <br> Busque o código BNCC acima para começar.</p>
            </div>
        {% endif %}
    </form>
</div>

{% for av in avaliacoes %}
<div class="modal fade" id="modalSugestao{{ av.competencia.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <form action="{% url 'sugerir_atividade' relatorio.id av.competencia.id %}" method="POST">
                {% csrf_token %}
                <div class="modal-header bg-warning border-0">
                    <h5 class="modal-title fw-bold"><i class="bi bi-lightbulb-fill"></i> Contribuir com Ideia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="small text-muted mb-4">Sua sugestão será analisada pela coordenação e poderá ser incluída no banco global de atividades.</p>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Título Curto</label>
                        <input type="text" name="titulo" class="form-control" required placeholder="Ex: Oficina de Jogos Matemáticos">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Público (Nível Alvo)</label>
                        <select name="nivel_alvo" class="form-select" required>
                            <option value="1">Alunos em Nível 1</option>
                            <option value="2">Alunos em Nível 2</option>
                            <option value="3">Alunos em Nível 3</option>
                            <option value="4">Alunos em Nível 4</option>
                            <option value="5">Alunos em Nível 5</option>
                        </select>
                    </div>

                    <div class="mb-0">
                        <label class="form-label fw-bold">Como aplicar?</label>
                        <textarea name="descricao" class="form-control" rows="5" required placeholder="Descreva o passo a passo da atividade..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-warning fw-bold px-4">Enviar para Análise</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<style>
    @media (min-width: 768px) {
        .border-end-md { border-right: 1px solid #dee2e6 !important; }
    }
    .card-body select:focus, .card-body textarea:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }
</style>
{% endblock %}