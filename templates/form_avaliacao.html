{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Avaliando {{ materia_codigo }}{% endblock %}

{% block content %}
<div class="container pb-5">
    
    <div class="mb-4">
        <a href="{% url 'avaliar_aluno' relatorio.aluno.id %}" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <h2 class="text-primary fw-bold mt-2">
            {{ materia_codigo }} <span class="text-muted fs-5">| {{ relatorio.aluno.nome_completo }}</span>
        </h2>
    </div>

    <div class="card bg-light border-primary border-opacity-25 mb-5 shadow-sm">
        <div class="card-body">
            <label class="fw-bold text-primary mb-2"><i class="bi bi-search"></i> Adicionar Competência à Avaliação</label>
            <form method="post" class="d-flex gap-2">
                {% csrf_token %}
                <input type="text" name="termo_busca" class="form-control" placeholder="Digite o código (Ex: EF01MA01) ou palavra-chave..." required>
                <button type="submit" name="btn_adicionar" class="btn btn-primary px-4 fw-bold">
                    <i class="bi bi-plus-lg"></i> Adicionar
                </button>
            </form>
            <div class="form-text small">Busque pelo código da BNCC. O sistema trará a competência correspondente a esta série.</div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        
        {% if avaliacoes %}
            <h5 class="fw-bold mb-3 text-secondary">Competências em Avaliação ({{ avaliacoes.count }})</h5>
            
            {% for av in avaliacoes %}
            <div class="card mb-3 shadow-sm border-start border-4 {% if av.nivel %}border-success{% else %}border-secondary{% endif %}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7 border-end">
                            <span class="badge bg-dark text-white mb-2">{{ av.competencia.codigo }}</span>

                            {% if not av.nivel %}
                                    <button type="submit" name="btn_excluir" value="{{ av.id }}" 
                                            class="btn btn-outline-danger btn-sm border-0" 
                                            title="Remover desta lista"
                                            onclick="return confirm('Tem certeza que deseja remover esta competência?');">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                {% else %}
                                    <span class="text-muted small" title="Item salvo (Bloqueado para exclusão)">
                                        <i class="bi bi-lock-fill"></i>
                                    </span>
                                {% endif %}

                            <p class="fw-bold mb-1">{{ av.competencia.habilidade }}</p>
                            
                            <div class="mt-3">
                                <a href="{% url 'sugerir_atividade' relatorio.id av.competencia.id %}" class="btn btn-outline-warning btn-sm text-dark" style="font-size: 0.8rem;">
                                    <i class="bi bi-lightbulb"></i> Sugerir Atividade
                                </a>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <label class="form-label fw-bold text-primary small">Nível:</label>
                            <select name="nivel_{{ av.competencia.id }}" class="form-select mb-2 bg-light">
                                <option value="">Selecione...</option>
                                <option value="1" {% if av.nivel == '1' %}selected{% endif %}>1 - Não desenvolvido</option>
                                <option value="2" {% if av.nivel == '2' %}selected{% endif %}>2 - Em desenvolvimento (início)</option>
                                <option value="3" {% if av.nivel == '3' %}selected{% endif %}>3 - Em desenvolvimento (parcial)</option>
                                <option value="4" {% if av.nivel == '4' %}selected{% endif %}>4 - Desenvolvido</option>
                                <option value="5" {% if av.nivel == '5' %}selected{% endif %}>5 - Plenamente desenvolvido</option>
                            </select>

                            <textarea name="obs_{{ av.competencia.id }}" class="form-control" rows="1" placeholder="Observação..." style="font-size: 0.9rem;">{{ av.observacao_especifica|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="d-grid gap-2 mt-4 mb-5">
                <button type="submit" name="btn_salvar" class="btn btn-success btn-lg shadow">
                    <i class="bi bi-check-circle-fill"></i> SALVAR TODAS AS NOTAS
                </button>
            </div>

        {% else %}
            <div class="text-center py-5 opacity-50">
                <i class="bi bi-arrow-up-circle display-4"></i>
                <h4 class="mt-3">Nenhuma competência selecionada</h4>
                <p>Use a barra de pesquisa acima para adicionar os objetivos que você trabalhou neste trimestre.</p>
            </div>
        {% endif %}
    </form>
</div>
{% endblock %}